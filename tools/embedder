#!/usr/bin/perl

use strict;
use Getopt::Long;
use IO::Compress::Gzip qw(gzip $GzipError);

my $myself = $0;
$myself =~ s|^.*/||;

my $WIDTH = 70;
my $regfunc = undef;
my @includes;

&GetOptions("register-function=s" => \$regfunc,
	    "include=s" => \@includes,
    );

# -----------------------------------------------------------------------------

print "/* Generated by $myself -- do not edit! */\n\n";
print "#include <gnumeric-config.h>\n";
print "#include <gnm-rsm.h>\n\n";
foreach (@includes) {
    print "#include \"$_\"\n";
}

my $fileno = 0;
my $reg = "";
my $docompress = 0;
foreach my $file (@ARGV) {
    if ($file eq 'COMPRESS') {
	$docompress = 1;
	next;
    }
    if ($file eq 'NOCOMPRESS') {
	$docompress = 0;
	next;
    }
    &embed ($file, $docompress);
}
print "void\n";
print "$regfunc (void)\n";
print "{\n";
print $reg;
print "}\n";

sub embed {
    my ($file, $docompress) = @_;

    print "/* Embedded file $file */\n";

    my $data;
    {
	local (*FIL);
	local ($/);
	$/ = undef;
	open (*FIL, "<$file") or die "$myself: cannot read $file: $!\n";
	$data = <FIL>;
    }

    if ($docompress) {
	my $zdata;
	gzip \$data => \$zdata
	    or die "gzip failed: $GzipError\n";
	$data = $zdata;
    }

    my $id = "data$fileno";
    $fileno++;

    &embed_data ($data, $id);

    my $len = length ($data);
    $reg .= "  gnm_rsm_register_file (\"$file\", $id, $len);\n";
}

sub embed_data {
    my ($data,$id) = @_;

    my $len = length ($data);
    if ($len == 0) {
	print "static const char ${id}[] = \"\";\n";
	return;
    }

    print "static const char ${id}[] =\n";
    my $linelen = 0;
    my $nohex = 0;
    foreach my $c (split (//, $data)) {
	if ($linelen > $WIDTH) {
	    print "\"\n";
	    $linelen = 0;
	}
	if ($linelen == 0) {
	    print "  \"";
	    $linelen += 3;
	} 

	my $thisnohex = $nohex;
	$nohex = 0;

	my $ci = ord ($c);
	if ($c eq "\n") {
	    print "\\n";
	    $linelen += 2;
	} elsif ($c eq "\t") {
	    print "\\t";
	    $linelen += 2;
	} elsif ($c eq '"') {
	    print "\\\"";
	    $linelen += 2;
	} elsif ($c eq "\\") {
	    print "\\\\";
	    $linelen += 2;
	} elsif ($ci >= 32 && $ci < 128) {
	    if ($thisnohex && $c =~ /[a-fA-f0-9]/) {
		print "\"\"";
		$linelen += 2;
	    }
	    print $c;
	    $linelen += 1;
	} else {
	    printf ("\\x%02x", $ci);
	    $linelen += 4;
	    $nohex = 1;
	}
    }
    print "\";\n\n";
}
